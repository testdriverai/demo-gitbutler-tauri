version: 6.0.0
session: sourceandsummitv6testing
steps:
  # Sample PROVISION script
  # Runs ONCE when your VM is created
  # to run other scripts before a test, see prerun.yaml
  # to run scripts after a test, see postrun.yaml
  # Docs for exec command: https://docs.testdriver.ai/commands/exec
  # Docs for lifecycle scripts: https://docs.testdriver.ai/guide/lifecycle
  - prompt: "Provision"
    commands:
      - command: exec
        lang: pwsh
        code: |
          # Install-GitButler.ps1
          Write-Host "Starting GitButler installation..."

          # Define variables
          $downloadUrl = "https://app.gitbutler.com/downloads/release/windows/x86_64/msi"
          $installerPath = Join-Path $env:TEMP "gitbutler.msi"
          $installDir = "C:\Program Files\GitButler"

          # Download the installer
          Write-Host "Downloading GitButler MSI..."
          Invoke-WebRequest -Uri $downloadUrl -OutFile $installerPath

          if (-Not (Test-Path $installerPath)) {
              Write-Error "Download failed. Exiting."
              exit 1
          }

          # Install silently
          Write-Host "Installing GitButler..."
          $installProcess = Start-Process msiexec.exe -ArgumentList "/i `"$installerPath`" /qn /norestart" -Wait -PassThru

          if ($installProcess.ExitCode -eq 0) {
              Write-Host "GitButler installed successfully!"
          } else {
              Write-Error "GitButler installation failed with exit code $($installProcess.ExitCode)."
              exit $installProcess.ExitCode
          }

          # Cleanup installer
          if (Test-Path $installerPath) {
              Remove-Item $installerPath -Force
              Write-Host "Cleaned up installer file."
          }

          # Update PATH if not already set
          $envPath = [System.Environment]::GetEnvironmentVariable("Path", "Machine")
          if ($envPath -notlike "*$installDir*") {
              Write-Host "Adding GitButler to PATH..."
              $newPath = "$envPath;$installDir"
              [System.Environment]::SetEnvironmentVariable("Path", $newPath, "Machine")
              Write-Host "GitButler path added. Restart your terminal for it to take effect."
          } else {
              Write-Host "GitButler path already in PATH."
          }
      - command: exec
        lang: pwsh
        code: |
          # Configure git to avoid interactive prompts
          git config --global core.sshCommand 'ssh -o StrictHostKeyChecking=accept-new'
          # Bypass "Login with GitHub" UI
          git config --global credential.helper manager-core

          Write-Host "Cloning https://github.com/testdriverai/gitbutler-remote-sample-repo"
          git clone --depth 1 https://github.com/testdriverai/gitbutler-remote-sample-repo.git C:\Users\testdriver\Desktop\gitbutler-remote-sample-repo


